<script>
  const USDT_CONTRACT = "0x55d398326f99059fF775485246999027B3197955";
  const BSC_RPC = "https://bsc-dataseed.binance.org/";

  async function getUSDTBalance(address) {
    const abi = [{
      "constant":true,
      "inputs":[{"name":"_owner","type":"address"}],
      "name":"balanceOf",
      "outputs":[{"name":"balance","type":"uint256"}],
      "type":"function"
    }];

    const provider = new ethers.providers.JsonRpcProvider(BSC_RPC);
    const contract = new ethers.Contract(USDT_CONTRACT, abi, provider);
    const rawBal = await contract.balanceOf(address);
    return parseFloat(ethers.utils.formatUnits(rawBal, 18)).toFixed(2);
  }

  connectBtn.addEventListener('click', async () => {
    if (window.ethereum) {
      try {
        const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
        currentAccount = accounts[0];
        walletAddressSpan.textContent = currentAccount;

        // Save wallet to backend (optional)
        const res = await fetch('http://localhost:5001/api/save_wallet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ wallet_address: currentAccount })
        });

        const ethData = await res.json();
        walletBalanceSpan.textContent = `${ethData.eth} ETH`;

        // Get BEP-20 USDT
        const usdt = await getUSDTBalance(currentAccount);
        const usdtDiv = document.createElement('div');
        usdtDiv.innerHTML = `<strong>USDT (BEP20):</strong> ${usdt}`;
        document.getElementById('walletBalance').after(usdtDiv);

      } catch (err) {
        alert('Connection failed: ' + err.message);
      }
    } else {
      alert('Trust Wallet or MetaMask not found.');
    }
  });
</script>
